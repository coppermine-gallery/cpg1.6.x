/**
 * Coppermine Photo Gallery
 *
 * v1.0 originally written by Gregory Demar
 *
 * @copyright  Copyright (c) 2003-2018 Coppermine Dev Team
 * @license    GNU General Public License version 3 or later; see LICENSE
 *
 * plugins/upload_h5a/js/upload.js
 * @since  1.6.05
 */
var redirURL="",h5u_albSel=null,stagger=!1;function $id(d){return document.getElementById(d)}function $ae(d,k,f){d.addEventListener(k,f,!1)}function H5up_done(d,k){var f=".php?album="+h5u_albSel.value;redirURL=0<js_vars.user_id||1==js_vars.guest_edit?js_vars.site_url+"/editpics"+f+"&newer_than="+js_vars.timestamp:js_vars.site_url+"/thumbnails"+f;d&&$.post("notifyupload.php",{album:h5u_albSel.value});"1"==js_vars.autoedit&&0===k?window.location=redirURL:$id("gotoedit").style.display="table-row"}
(function(d,k,f){function F(b){h5u_albSel.value||(b.stopPropagation(),b.preventDefault(),alert(js_vars.h5uM.selAlb))}function v(b){b.stopPropagation();b.preventDefault();b.target.className="dragover"==b.type?"hover":""}function C(b){var a,c;D=q.offsetWidth;v(b);if(h5u_albSel.value){w&&(w=x=y=0);b=b.target.files||b.dataTransfer.files;for(a=0;c=b[a];a++)x+=c.size,e.push(c),r.innerHTML=e.length,stagger||n(!1,"fsel");stagger&&n(!1,"fsel");e.length>t&&(l.style.display="inline-block")}else alert(js_vars.h5uM.selAlb)}
function E(){g||(w=1,typeof("function"==H5up_done)&&H5up_done(z,A),A=z=0)}function n(b,a){b&&("ufo"==a&&z++,--h||E());if(!g&&e.length&&(!t||h<t)){var c=e.shift();new G(c);h++;r.innerHTML=e.length}0>=e.length&&(l.style.display="none",m.style.display="none")}function H(b,a){var c=this;c.show=function(a){c.pb.style.backgroundPosition=Math.floor(c.pb.offsetWidth*a)+"px 0";1===a&&(c.pb.innerHTML=c.fObj.fileName,c.pb.className="indeterm")};c.msg=function(a,b){c.pb.innerHTML+="<br />"+a;b&&(c.pb.className=
"failure",A++)};c.remove=function(){c.pb._ufo=null;B.removeChild(c.pb);c.fObj=null};c.pb=B.appendChild(document.createElement("p"));a&&(c.pb.className=a);c.pb.appendChild(document.createTextNode(b.fileName));c.pb.innerHTML+='<img src="'+js_vars.H5uPath+'css/redX.png" class="abortX" onclick="this.parentNode._ufo.abort(true);" />';c.pb._ufo=b;c.fObj=b;return this}function u(b){!q||0>b||(y+=b,q.style.backgroundPosition=Math.floor(D*y/x)+"px 0")}function I(){var b={},a;for(a in f){var c=f[a];var d=$id(c);
if(d)switch(d.type){case "checkbox":b[c]=d.checked?1:0;break;default:b[c]=d.value}}b.album=h5u_albSel.value;return b}function p(b,a){for(var c in a)b.append(c,a[c])}function G(b){var a=this;a.upFile=b;a.fileName=b.fileName||b.name;a.size=b.size;a.upState="";a.doChnk=a.upFile.size>js_vars.maxchunksize;a.chnkSize=Math.round(js_vars.maxchunksize/2)-3072;a.relPath=b.webkitRelativePath||a.fileName;a.uniqueId=a.size+"-"+a.relPath.replace(/[^0-9a-zA-Z_-]/img,"");a.actSize=0;a.startByte=0;a.lastsz=0;a.numChnks=
Math.max(Math.floor(a.size/a.chnkSize),1);a.chnkNum=0;a.fData=null;a.upForm=I();a.xhr=new XMLHttpRequest;var c=a.upFile.slice?"slice":a.upFile.mozSlice?"mozSlice":a.upFile.webkitSlice?"webkitSlice":"slice",d=function(b){a.xhr&&(a.xhr.upload.onprogress=null,a.xhr.onabort=null,a.xhr.onerror=null,a.xhr.onload=null,a.xhr=null);a.fData=null;b&&a.pBar&&(a.pBar.remove(),a.pBar=null);n(!0,"ufo")},e=function(){a.fData=new FormData;p(a.fData,js_vars.fup_payload)},f=function(){e();switch(a.upState){case "":p(a.fData,
a.upForm);a.fData.append("Filedata",a.upFile);a.upState="upld";break;case "upld":d(!0);return}a.xhr.open("POST",k);a.xhr.send(a.fData)},l=function(){e();switch(a.upState){case "":p(a.fData,{chunkact:"pref",file:a.fileName,size:a.size,album:h5u_albSel.value});a.upState="chnk";break;case "chnk":p(a.fData,{chunkact:"chnk",identifier:a.uniqueId,filename:a.fileName,totalChunks:a.numChnks});if(a.chnkNum==a.numChnks){d(!0);return}a.startByte=a.chnkNum*a.chnkSize;a.endByte=Math.min(a.size,(a.chnkNum+1)*a.chnkSize);
a.size-a.endByte<a.chnkSize&&(a.endByte=a.size);a.actSize=a.endByte-a.startByte;a.fData.append("chunkNumber",++a.chnkNum);a.chnkNum==a.numChnks&&p(a.fData,a.upForm);a.fData.append("Filedata",a.upFile[c](a.startByte,a.endByte));a.lastsz=0;break;case "abrt":a.xhr.timeout=1E4;p(a.fData,{chunkact:"abrt",identifier:a.uniqueId,filename:a.fileName});a.upState="nil";break;case "nil":d();return}a.xhr.open("POST",k);a.xhr.send(a.fData)},g={prog:function(b){if(b.lengthComputable){var c=Math.round(b.loaded/b.total*
a.actSize);"chnk"==a.upState&&a.chnkNum?(a.pBar.show((a.startByte+c)/a.size),u(c-a.lastsz),a.lastsz=c):"upld"==a.upState&&(a.pBar.show(b.loaded/b.total),c=Math.round(b.loaded/b.total*a.size),u(c-a.lastsz),a.lastsz=c)}},chng:function(b){4>this.readyState||(200!==this.status?(u(a.size-a.startByte-a.lastsz),a.lastsz=a.size,0===this.status?(a.pBar.msg("-- "+js_vars.h5uM.aborted,!0),a.doChnk?(a.upState="abrt",l()):d()):(a.pBar.msg(this.statusText||this.status,!0),d())):200===this.status&&(this.responseText.length?
a.pBar.msg(this.responseText,!0):a.doChnk?l():f()))},fail:function(b){a.pBar.msg(a.xhr.responseText,!0)}};a.abort=function(b){a.xhr?(b=a.xhr.readyState,4>b&&0!==b?a.xhr.abort():g.abrt()):(a.pBar.remove(),a.pBar=null)};a.pBar=new H(a,a.doChnk?"chunked":"");var h="",m=b.name.split(".");1==m.length||"object"==typeof js_vars.allowed_file_types&&0>js_vars.allowed_file_types.indexOf(m.pop().toLowerCase())?h='<img src="'+js_vars.H5uPath+'css/info.png" class="infog" onclick="showAllowedExts();" /> '+js_vars.h5uM.type_err:
b.size>js_vars.maxfilesize&&(h=js_vars.h5uM.size_err);if(h)a.pBar.msg(h,!0),u(b.size),a.xhr=null,n(!0,"errM");else return a.xhr.onreadystatechange=g.chng,a.xhr.upload.onerror=g.fail,a.xhr.upload.onprogress=g.prog,a.doChnk?l():f(),this}var q,D,B,r,e=[],t=js_vars.concurrent,g=!1,h=0,x=0,y=0,w=0,z=0,A=0,l,m;d.H5uSetup=function(){var b=$id("upload_field"),a=$id("dropArea");d.File&&d.FileList?(r=$id("qcount"),l=$id("qstop"),m=$id("qgocan"),b&&($ae(b,"click",F),$ae(b,"change",C)),b=new XMLHttpRequest,b.upload&&
($ae(a,"dragover",v),$ae(a,"dragleave",v),$ae(a,"drop",C),a.style.display="block",q=$id("totprogress"),B=$id("fprogress")),h5u_albSel=document.getElementsByName("h5u_album")[0]):($id("h5upldrow").style.display="none",$id("navailrow").style.display="table-row")};d.H5uQctrl={stop:function(){g=!0;l.style.display="none";m.style.display="inline-block"},go:function(){g=!1;l.style.display="inline-block";m.style.display="none";if(stagger)n(!1,"go");else for(;e.length&&h<t;)n(!1,"go")},cancel:function(){e.length=
0;g=!1;m.style.display="none";r.innerHTML=0;h||E()}}})(window,"uniload.php","autorient flistitl title caption keywords user1 user2 user3 user4".split(" "));function showAllowedExts(){alert(js_vars.h5uM.extallow+js_vars.allowed_file_types.join(", "))}function shide_titlrow(d){var k=$id("titlrow");d.checked?k.style.display="none":k.style.display="table-row"}$(document).ready(function(){H5uSetup()});