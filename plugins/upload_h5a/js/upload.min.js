/*
 Copyright (c) 2003-2023 Coppermine Dev Team
 @license    GNU General Public License version 3 or later; see LICENSE

 plugins/upload_h5a/js/upload.min.js
 @since  1.6.22
*/
'use strict';var redirURL="",h5u_albSel=null,stagger=!1;function $id(f){return document.getElementById(f)}function $ae(f,h,k){f.addEventListener(h,k,!1)}
function H5up_done(f,h){var k=".php?album="+h5u_albSel.value;redirURL=0<js_vars.user_id||1==js_vars.guest_edit?js_vars.site_url+"/editpics"+k+"&newer_than="+js_vars.timestamp:js_vars.site_url+"/thumbnails"+k;f&&$.post("notifyupload.php",{album:h5u_albSel.value});"1"==js_vars.autoedit&&0===h?window.location=redirURL:$id("gotoedit").style.display="table-row"}
(function(f,h,k){function O(b){h5u_albSel.value||(b.stopPropagation(),b.preventDefault(),alert(js_vars.h5uM.selAlb))}function B(b){b.stopPropagation();b.preventDefault();b.target.className="dragover"==b.type?"hover":""}function J(b){var a,c;K=u.offsetWidth;B(b);if(h5u_albSel.value){C&&(C=D=E=0);b=b.target.files||b.dataTransfer.files;for(a=0;c=b[a];a++)D+=c.size,g.push(c),v.innerHTML=g.length,stagger||l(!1,"fsel");stagger&&l(!1,"fsel");g.length>w&&(p.style.display="inline-block")}else alert(js_vars.h5uM.selAlb)}
function L(){q||(C=1,typeof("function"==H5up_done)&&H5up_done(F,G),G=F=0)}function l(b,a){b&&("ufo"==a&&F++,--r||g.length||L());!q&&g.length&&(!w||r<w)&&(b=g.shift(),new P(b),r++,v.innerHTML=g.length);0>=g.length&&(p.style.display="none",t.style.display="none")}function Q(b,a){var c=this;c.show=function(d){c.pb.style.backgroundPosition=Math.floor(c.pb.offsetWidth*d)+"px 0";1===d&&(c.pb.innerHTML=c.fObj.fileName,c.pb.className="indeterm")};c.msg=function(d,x){c.pb.innerHTML+="<br />"+d;x&&(c.pb.className=
"failure",G++)};c.remove=function(){c.pb._ufo=null;H.removeChild(c.pb);c.fObj=null};c.pb=H.appendChild(document.createElement("p"));a&&(c.pb.className=a);c.pb.appendChild(document.createTextNode(b.fileName));c.pb.innerHTML+='<img src="'+js_vars.H5uPath+'css/redX.png" class="abortX" onclick="this.parentNode._ufo.abort(true);" />';c.pb._ufo=b;c.fObj=b;return this}function y(b){!u||0>b||(E+=b,u.style.backgroundPosition=Math.floor(K*E/D)+"px 0")}function R(){var b={},a;for(a in k){var c=k[a];var d=$id(c);
if(d)switch(d.type){case "checkbox":b[c]=d.checked?1:0;break;default:b[c]=d.value}}b.album=h5u_albSel.value;return b}function m(b,a){for(var c in a)b.append(c,a[c])}function P(b){var a=this;a.upFile=b;a.fileName=b.fileName||b.name;a.size=b.size;a.upState="";a.doChnk=a.upFile.size>js_vars.maxchunksize;a.chnkSize=Math.round(js_vars.maxchunksize/2)-3072;a.relPath=b.webkitRelativePath||a.fileName;a.uniqueId=a.size+"-"+a.relPath.replace(/[^0-9a-zA-Z_-]/img,"");a.actSize=0;a.startByte=0;a.lastsz=0;a.numChnks=
Math.max(Math.floor(a.size/a.chnkSize),1);a.chnkNum=0;a.fData=null;a.upForm=R();a.xhr=new XMLHttpRequest;var c=a.upFile.slice?"slice":a.upFile.mozSlice?"mozSlice":a.upFile.webkitSlice?"webkitSlice":"slice",d=function(e){a.xhr&&(a.xhr.upload.onprogress=null,a.xhr.onabort=null,a.xhr.onerror=null,a.xhr.onload=null,a.xhr=null);a.fData=null;e&&a.pBar&&(a.pBar.remove(),a.pBar=null);l(!0,"ufo")},x=function(){a.fData=new FormData;m(a.fData,js_vars.fup_payload)},M=function(){x();switch(a.upState){case "":m(a.fData,
a.upForm);a.fData.append("Filedata",a.upFile);a.upState="upld";break;case "upld":d(!0);return}a.xhr.open("POST",h);a.xhr.send(a.fData)},I=function(){x();switch(a.upState){case "":m(a.fData,{chunkact:"pref",file:a.fileName,size:a.size,album:h5u_albSel.value});a.upState="chnk";break;case "chnk":m(a.fData,{chunkact:"chnk",identifier:a.uniqueId,filename:a.fileName,totalChunks:a.numChnks});if(a.chnkNum==a.numChnks){d(!0);return}a.startByte=a.chnkNum*a.chnkSize;a.endByte=Math.min(a.size,(a.chnkNum+1)*a.chnkSize);
a.size-a.endByte<a.chnkSize&&(a.endByte=a.size);a.actSize=a.endByte-a.startByte;a.fData.append("chunkNumber",++a.chnkNum);a.chnkNum==a.numChnks&&m(a.fData,a.upForm);a.fData.append("Filedata",a.upFile[c](a.startByte,a.endByte));a.lastsz=0;break;case "abrt":a.xhr.timeout=1E4;m(a.fData,{chunkact:"abrt",identifier:a.uniqueId,filename:a.fileName});a.upState="nil";break;case "nil":d();return}a.xhr.open("POST",h);a.xhr.send(a.fData)},z={prog:function(e){if(e.lengthComputable){var n=Math.round(e.loaded/e.total*
a.actSize);"chnk"==a.upState&&a.chnkNum?(a.pBar.show((a.startByte+n)/a.size),y(n-a.lastsz),a.lastsz=n):"upld"==a.upState&&(a.pBar.show(e.loaded/e.total),n=Math.round(e.loaded/e.total*a.size),y(n-a.lastsz),a.lastsz=n)}},chng:function(e){4>this.readyState||(200!==this.status?(y(a.size-a.startByte-a.lastsz),a.lastsz=a.size,0===this.status?(a.pBar.msg("-- "+js_vars.h5uM.aborted,!0),a.doChnk?(a.upState="abrt",I()):d()):(a.pBar.msg(this.responseText||this.response||this.statusText||this.status,!0),d())):
200===this.status&&(this.responseText.length?a.pBar.msg(this.responseText,!0):a.doChnk?I():M()))},fail:function(e){a.pBar.msg(a.xhr.responseText,!0)}};a.abort=function(e){a.xhr?(e=a.xhr.readyState,4>e&&0!==e?a.xhr.abort():z.abrt()):(a.pBar.remove(),a.pBar=null)};a.pBar=new Q(a,a.doChnk?"chunked":"");var A="",N=b.name.split(".");1==N.length||"object"==typeof js_vars.allowed_file_types&&0>js_vars.allowed_file_types.indexOf(N.pop().toLowerCase())?A='<img src="'+js_vars.H5uPath+'css/info.png" class="infog" onclick="showAllowedExts();" /> '+
js_vars.h5uM.type_err:b.size>js_vars.maxfilesize&&(A=js_vars.h5uM.size_err);if(A)a.pBar.msg(A,!0),y(b.size),a.xhr=null,l(!0,"errM");else return a.xhr.onreadystatechange=z.chng,a.xhr.upload.onerror=z.fail,a.xhr.upload.onprogress=z.prog,a.doChnk?I():M(),this}var u,K,H,v,g=[],w=js_vars.concurrent,q=!1,r=0,D=0,E=0,C=0,F=0,G=0,p,t;f.H5uSetup=function(){var b=$id("upload_field"),a=$id("dropArea");f.File&&f.FileList?(v=$id("qcount"),p=$id("qstop"),t=$id("qgocan"),b&&($ae(b,"click",O),$ae(b,"change",J)),
b=new XMLHttpRequest,b.upload&&($ae(a,"dragover",B),$ae(a,"dragleave",B),$ae(a,"drop",J),a.style.display="block",u=$id("totprogress"),H=$id("fprogress")),h5u_albSel=document.getElementsByName("h5u_album")[0]):($id("h5upldrow").style.display="none",$id("navailrow").style.display="table-row")};f.H5uQctrl={stop:function(){q=!0;p.style.display="none";t.style.display="inline-block"},go:function(){q=!1;p.style.display="inline-block";t.style.display="none";if(stagger)l(!1,"go");else for(;g.length&&r<w;)l(!1,
"go")},cancel:function(){g.length=0;q=!1;t.style.display="none";v.innerHTML=0;r||L()}}})(window,"uniload.php","autorient flistitl title caption keywords user1 user2 user3 user4".split(" "));function showAllowedExts(){alert(js_vars.h5uM.extallow+js_vars.allowed_file_types.join(", "))}function shide_titlrow(f){var h=$id("titlrow");f.checked?h.style.display="none":h.style.display="table-row"}$(document).ready(function(){H5uSetup()});